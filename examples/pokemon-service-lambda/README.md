# Pokémon Service - AWS Lambda Example

This example demonstrates how to deploy a Smithy-generated Rust service to AWS Lambda using the `aws-smithy-http-server` framework.

## Key Features

This example showcases:

- **LambdaHandler**: Adapts a Smithy-generated service to work with AWS Lambda
- **Lambda Context Extraction**: Access Lambda execution context (request ID, memory, deadline, etc.) via `FromParts`
- **HTTP Request Handling**: Supports API Gateway, ALB, and Lambda Function URLs
- **Generated SDK**: Uses a Smithy-generated server SDK with the `aws-lambda` feature enabled

## Architecture

```
┌─────────────────────────────────────────┐
│  API Gateway / ALB / Function URL       │
└──────────────────┬──────────────────────┘
                   │ Lambda HTTP Event
                   ▼
┌─────────────────────────────────────────┐
│  LambdaHandler (from smithy-http-server)│
│  - Converts lambda_http::Request        │
│  - Preserves Lambda Context in extensions│
└──────────────────┬──────────────────────┘
                   │ http::Request<BoxBodySync>
                   ▼
┌─────────────────────────────────────────┐
│  PokemonService (Generated by Smithy)   │
│  - Routes to operation handlers         │
│  - Extracts Lambda Context via FromParts│
└─────────────────────────────────────────┘
```

## Extracting Lambda Context in Handlers

The Lambda execution context is automatically available in your operation handlers via the `FromParts` trait. Simply add `Context` as a parameter:

```rust
use pokemon_service_server_sdk::server::request::lambda::Context;

pub async fn get_storage_lambda(
    input: GetStorageInput,
    _state: Extension<Arc<State>>,
    context: Context,  // <-- Lambda context automatically extracted!
) -> Result<GetStorageOutput, GetStorageError> {
    // Access Lambda context information
    tracing::debug!(
        request_id = %context.request_id,
        function_name = %context.env_config.function_name,
        memory = context.env_config.memory,
        "Processing request"
    );

    // Your handler logic here...
    Ok(GetStorageOutput { collection: vec![] })
}
```

The `Context` provides:
- `request_id` - Unique identifier for the Lambda invocation
- `invoked_function_arn` - ARN of the function being invoked
- `env_config.function_name` - Name of the Lambda function
- `env_config.memory` - Memory allocated to the function (MB)
- `deadline` - Unix timestamp (ms) when the function times out

## Prerequisites

1. **Java 17** - Required to run the Smithy code generator
2. **Rust** - Including `cargo` to compile the generated code
3. **Cargo Lambda** - Required for local testing and deployment

### Installing Cargo Lambda

**macOS (Homebrew):**
```bash
brew tap cargo-lambda/cargo-lambda
brew install cargo-lambda
```

**Windows (Scoop):**
```bash
scoop bucket add cargo-lambda https://github.com/cargo-lambda/scoop-cargo-lambda
scoop install cargo-lambda/cargo-lambda
```

**Amazon Linux / Any system with Python 3:**
```bash
pip3 install cargo-lambda
```

**Using uv:**
```bash
uv tool install cargo-lambda
```

## Getting Started

### Step 1: Generate the SDK

From the `/examples` directory, run:

```bash
make codegen
```

This will:
1. Run the Smithy code generator via Gradle
2. Generate the `pokemon-service-server-sdk` crate with the `aws-lambda` feature
3. Copy the generated code to the examples directory

### Step 2: Build the Lambda Function

```bash
cd pokemon-service-lambda
cargo build
```

## Local Testing

### Start the Local Lambda Emulator

From the `/examples` directory:

```bash
make lambda_watch
```

Or directly with cargo lambda:

```bash
cd pokemon-service-lambda
cargo lambda watch
```

This starts a local Lambda runtime emulator on `http://localhost:9000`.

### Invoke the Function Locally

**Option 1: Using the Makefile (from `/examples` directory)**

```bash
make lambda_invoke
```

This sends a test API Gateway request to the `get_storage` operation.

**Option 2: Using cargo lambda directly**

```bash
cargo lambda invoke pokemon-service-lambda \
  --data-file ../pokemon-service/tests/fixtures/example-apigw-request.json
```

**Option 3: Using curl**

```bash
# Access via browser or curl
curl http://localhost:9000/

# Example: Get Pokémon species
curl http://localhost:9000/pokemon-species/pikachu

# Example: Check health
curl http://localhost:9000/ping
```

**Option 4: Using cargo lambda invoke with custom data**

```bash
# Simple invoke
cargo lambda invoke pokemon-service-lambda --data-example apigw-request

# With custom payload
cargo lambda invoke pokemon-service-lambda --data-ascii '{
  "httpMethod": "GET",
  "path": "/pokemon-species/charmander",
  "headers": {"content-type": "application/json"}
}'
```

## Deploying to AWS Lambda

### Build for Lambda

**For x86_64 (Intel/AMD):**
```bash
cargo lambda build --release
```

**For ARM64 (Graviton processors - recommended for cost savings):**
```bash
cargo lambda build --release --arm64
```

The compiled Lambda function will be in `target/lambda/pokemon-service-lambda/bootstrap.zip`.

### Deploy to AWS

**Option 1: Using cargo lambda (creates IAM role automatically)**

```bash
cargo lambda deploy
```

**Option 2: Using cargo lambda with existing IAM role**

```bash
cargo lambda deploy --iam-role arn:aws:iam::YOUR_ACCOUNT:role/lambda-execution-role
```

**Option 3: Manual deployment with AWS CLI**

```bash
aws lambda create-function \
  --function-name pokemon-service-lambda \
  --handler bootstrap \
  --zip-file fileb://target/lambda/pokemon-service-lambda/bootstrap.zip \
  --runtime provided.al2023 \
  --role arn:aws:iam::YOUR_ACCOUNT:role/lambda-execution-role \
  --environment Variables={RUST_LOG=info} \
  --architectures arm64
```

### Invoke the Deployed Function

```bash
# Invoke remotely
cargo lambda invoke --remote pokemon-service-lambda \
  --data-file ../pokemon-service/tests/fixtures/example-apigw-request.json

# Or with AWS CLI
aws lambda invoke \
  --function-name pokemon-service-lambda \
  --payload file://path/to/request.json \
  response.json
```

## Integration with API Gateway

To expose your Lambda function via HTTP, you can:

1. **Lambda Function URLs** (simplest):
   ```bash
   aws lambda create-function-url-config \
     --function-name pokemon-service-lambda \
     --auth-type NONE
   ```

2. **API Gateway HTTP API**:
   - Create an HTTP API in API Gateway console
   - Add a route with Lambda integration
   - The `LambdaHandler` automatically handles API Gateway request/response formats

3. **Application Load Balancer (ALB)**:
   - Configure ALB target group with Lambda target
   - The `LambdaHandler` supports ALB request formats

## Available Operations

The Pokémon service implements these operations:

- `GET /pokemon-species/{name}` - Get information about a Pokémon species
- `GET /storage` - Retrieve user's Pokémon storage (requires auth)
- `GET /pokemon-stats` - Get server statistics
- `POST /capture-pokemon` - Capture a Pokémon
- `GET /do-nothing` - No-op endpoint
- `GET /ping` - Health check endpoint
- `GET /radio` - Stream Pokémon radio (event stream)

## Testing

Run the integration tests:

```bash
cargo test
```

## Code Structure

```
pokemon-service-lambda/
├── src/
│   ├── main.rs      # Lambda entry point, sets up LambdaHandler
│   └── lib.rs       # get_storage_lambda handler (demonstrates Context extraction)
├── tests/           # Integration tests
└── Cargo.toml       # Dependencies (includes lambda_http and server SDK with aws-lambda feature)
```

## Key Implementation Details

### Main Lambda Entry Point (`src/main.rs`)

```rust
let app = PokemonService::builder(config)
    .get_pokemon_species(get_pokemon_species)
    .get_storage(get_storage_lambda)  // Uses Lambda Context
    // ... other operations
    .build()
    .expect("failed to build service");

// Wrap with LambdaHandler
let handler = LambdaHandler::new(app);

// Run with lambda_http runtime
lambda_http::run(handler).await
```

### Handler with Lambda Context (`src/lib.rs`)

```rust
pub async fn get_storage_lambda(
    input: GetStorageInput,
    _state: Extension<Arc<State>>,
    context: Context,  // Extracted via FromParts
) -> Result<GetStorageOutput, GetStorageError> {
    tracing::debug!(request_id = %context.request_id, "authenticating user");
    // Handler logic...
}
```

## Troubleshooting

### "Missing AWS_LAMBDA_FUNCTION_NAME env var"

This error occurs when running the binary directly without the Lambda runtime environment. Use `cargo lambda watch` instead.

### "No SDK found"

Run `make codegen` from the `/examples` directory to generate the server SDK.

### Function timing out

Increase the Lambda timeout in your function configuration:
```bash
aws lambda update-function-configuration \
  --function-name pokemon-service-lambda \
  --timeout 30  # seconds
```

## Further Reading

- [Smithy Rust Server Middleware](https://smithy-lang.github.io/smithy-rs/design/server/middleware.html)
- [FromParts Extractors](https://smithy-lang.github.io/smithy-rs/design/server/from_parts.html)
- [Cargo Lambda Documentation](https://www.cargo-lambda.info/)
- [AWS Lambda Rust Runtime](https://github.com/awslabs/aws-lambda-rust-runtime)
