<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RFC-0028: SDK Credential Cache Type Safety - Smithy Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Design Overview</a></li><li class="chapter-item expanded "><a href="../tenets.html"><strong aria-hidden="true">2.</strong> Tenets</a></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">3.</strong> Design FAQ</a></li><li class="chapter-item expanded "><a href="../transport/overview.html"><strong aria-hidden="true">4.</strong> Transport</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../transport/operation.html"><strong aria-hidden="true">4.1.</strong> HTTP Operations</a></li><li class="chapter-item expanded "><a href="../transport/middleware.html"><strong aria-hidden="true">4.2.</strong> HTTP Middleware</a></li><li class="chapter-item expanded "><a href="../transport/connector.html"><strong aria-hidden="true">4.3.</strong> TLS Connector</a></li></ol></li><li class="chapter-item expanded "><a href="../smithy/overview.html"><strong aria-hidden="true">5.</strong> Smithy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../smithy/simple_shapes.html"><strong aria-hidden="true">5.1.</strong> Simple Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/recursive_shapes.html"><strong aria-hidden="true">5.2.</strong> Recursive Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/aggregate_shapes.html"><strong aria-hidden="true">5.3.</strong> Aggregate Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/endpoint.html"><strong aria-hidden="true">5.4.</strong> Endpoint Resolution</a></li><li class="chapter-item expanded "><a href="../smithy/backwards-compat.html"><strong aria-hidden="true">5.5.</strong> Backwards Compatibility</a></li></ol></li><li class="chapter-item expanded "><a href="../client/overview.html"><strong aria-hidden="true">6.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client/orchestrator.html"><strong aria-hidden="true">6.1.</strong> What is the 'orchestrator' and why does it exist?</a></li><li class="chapter-item expanded "><a href="../client/identity_and_auth.html"><strong aria-hidden="true">6.2.</strong> Identity and Auth</a></li></ol></li><li class="chapter-item expanded "><a href="../server/overview.html"><strong aria-hidden="true">7.</strong> Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server/middleware.html"><strong aria-hidden="true">7.1.</strong> Middleware</a></li><li class="chapter-item expanded "><a href="../server/instrumentation.html"><strong aria-hidden="true">7.2.</strong> Instrumentation</a></li><li class="chapter-item expanded "><a href="../server/from_parts.html"><strong aria-hidden="true">7.3.</strong> Accessing Un-modelled Data</a></li><li class="chapter-item expanded "><a href="../server/anatomy.html"><strong aria-hidden="true">7.4.</strong> The Anatomy of a Service</a></li><li class="chapter-item expanded "><a href="../server/code_generation.html"><strong aria-hidden="true">7.5.</strong> Generating Common Service Code</a></li></ol></li><li class="chapter-item expanded "><a href="../rfcs/overview.html"><strong aria-hidden="true">8.</strong> RFCs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfcs/rfc0001_shared_config.html"><strong aria-hidden="true">8.1.</strong> RFC-0001: Sharing configuration between multiple clients</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0002_http_versions.html"><strong aria-hidden="true">8.2.</strong> RFC-0002: Supporting multiple HTTP versions for SDKs that use Event Stream</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0003_presigning_api.html"><strong aria-hidden="true">8.3.</strong> RFC-0003: API for Pre-signed URLs</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0004_retry_behavior.html"><strong aria-hidden="true">8.4.</strong> RFC-0004: Retry Behavior</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0005_service_generation.html"><strong aria-hidden="true">8.5.</strong> RFC-0005: Smithy Rust service framework</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0006_service_specific_middleware.html"><strong aria-hidden="true">8.6.</strong> RFC-0006: Service-specific middleware</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0007_split_release_process.html"><strong aria-hidden="true">8.7.</strong> RFC-0007: Split release process</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0008_paginators.html"><strong aria-hidden="true">8.8.</strong> RFC-0008: Paginators</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0009_example_consolidation.html"><strong aria-hidden="true">8.9.</strong> RFC-0009: Example Consolidation</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0010_waiters.html"><strong aria-hidden="true">8.10.</strong> RFC-0010: Waiters</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0011_crates_io_alpha_publishing.html"><strong aria-hidden="true">8.11.</strong> RFC-0011: Publishing Alpha to Crates.io</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0012_independent_crate_versioning.html"><strong aria-hidden="true">8.12.</strong> RFC-0012: Independent Crate Versioning</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0013_body_callback_apis.html"><strong aria-hidden="true">8.13.</strong> RFC-0013: Body Callback APIs</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0014_timeout_config.html"><strong aria-hidden="true">8.14.</strong> RFC-0014: Fine-grained timeout configuration</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0015_using_features_responsibly.html"><strong aria-hidden="true">8.15.</strong> RFC-0015: How Cargo "features" should be used in the SDK and runtime crates</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0016_flexible_checksum_support.html"><strong aria-hidden="true">8.16.</strong> RFC-0016: Supporting Flexible Checksums</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0017_customizable_client_operations.html"><strong aria-hidden="true">8.17.</strong> RFC-0017: Customizable Client Operations</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0018_logging_sensitive.html"><strong aria-hidden="true">8.18.</strong> RFC-0018: Logging in the Presence of Sensitive Data</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0019_event_streams_errors.html"><strong aria-hidden="true">8.19.</strong> RFC-0019: Event Streams Errors</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0020_service_builder.html"><strong aria-hidden="true">8.20.</strong> RFC-0020: Service Builder Improvements</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0021_dependency_versions.html"><strong aria-hidden="true">8.21.</strong> RFC-0021: Dependency Versions</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0022_error_context_and_compatibility.html"><strong aria-hidden="true">8.22.</strong> RFC-0022: Error Context and Compatibility</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0023_refine_builder.html"><strong aria-hidden="true">8.23.</strong> RFC-0023: Evolving the new service builder API</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0024_request_id.html"><strong aria-hidden="true">8.24.</strong> RFC-0024: RequestID</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0025_constraint_traits.html"><strong aria-hidden="true">8.25.</strong> RFC-0025: Constraint traits</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0026_client_crate_organization.html"><strong aria-hidden="true">8.26.</strong> RFC-0026: Client Crate Organization</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0027_endpoints_20.html"><strong aria-hidden="true">8.27.</strong> RFC-0027: Endpoints 2.0</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0028_sdk_credential_cache_type_safety.html" class="active"><strong aria-hidden="true">8.28.</strong> RFC-0028: SDK Credential Cache Type Safety</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0029_new_home_for_cred_types.html"><strong aria-hidden="true">8.29.</strong> RFC-0029: Finding New Home for Credential Types</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0030_serialization_and_deserialization.html"><strong aria-hidden="true">8.30.</strong> RFC-0030: Serialization And Deserialization</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0031_providing_fallback_credentials_on_timeout.html"><strong aria-hidden="true">8.31.</strong> RFC-0031: Providing Fallback Credentials on Timeout</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0032_better_constraint_violations.html"><strong aria-hidden="true">8.32.</strong> RFC-0032: Better Constraint Violations</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0033_improve_sdk_request_id_access.html"><strong aria-hidden="true">8.33.</strong> RFC-0033: Improving access to request IDs in SDK clients</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0034_smithy_orchestrator.html"><strong aria-hidden="true">8.34.</strong> RFC-0034: Smithy Orchestrator</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0035_collection_defaults.html"><strong aria-hidden="true">8.35.</strong> RFC-0035: Collection Defaults</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0036_http_dep_elimination.html"><strong aria-hidden="true">8.36.</strong> RFC-0036: HTTP Dependency Exposure</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0037_http_wrapper.html"><strong aria-hidden="true">8.37.</strong> RFC-0037: The HTTP Wrapper</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0038_retry_classifier_customization.html"><strong aria-hidden="true">8.38.</strong> RFC-0038: User-configurable retry classification</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0039_forward_compatible_errors.html"><strong aria-hidden="true">8.39.</strong> RFC-0039: Forward Compatible Errors</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0040_behavior_versions.html"><strong aria-hidden="true">8.40.</strong> RFC-0040: Behavior Versions</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0041_improve_client_error_ergonomics.html"><strong aria-hidden="true">8.41.</strong> RFC-0041: Improve client error ergonomics</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0042_file_per_change_changelog.html"><strong aria-hidden="true">8.42.</strong> RFC-0042: File-per-change changelog</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0043_identity_cache_partitions.html"><strong aria-hidden="true">8.43.</strong> RFC-0043: Identity Cache Partitions</a></li></ol></li><li class="chapter-item expanded "><a href="../contributing/overview.html"><strong aria-hidden="true">9.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contributing/writing_and_debugging_a_low-level_feature_that_relies_on_HTTP.html"><strong aria-hidden="true">9.1.</strong> Writing and debugging a low-level feature that relies on HTTP</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Smithy Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rfc-sdk-credential-cache-type-safety"><a class="header" href="#rfc-sdk-credential-cache-type-safety">RFC: SDK Credential Cache Type Safety</a></h1>
<blockquote>
<p>Status: Implemented in <a href="https://github.com/smithy-lang/smithy-rs/pull/2122">smithy-rs#2122</a></p>
<p>Applies to: AWS SDK for Rust</p>
</blockquote>
<p>At time of writing (2022-10-11), the SDK's credentials provider can be customized by providing:</p>
<ol>
<li>A profile credentials file to modify the default provider chain</li>
<li>An instance of one of the credentials providers implemented in <code>aws-config</code>, such as
the <code>AssumeRoleCredentialsProvider</code>, <code>ImdsCredentialsProvider</code>, and so on.</li>
<li>A custom struct that implements the <code>ProvideCredentials</code></li>
</ol>
<p>The problem this RFC examines is that when options 2 and 3 above are exercised, the customer
needs to be aware of credentials caching and put additional effort to ensure caching is set up
correctly (and that double caching doesn't occur). This is especially difficult to get right
since some built-in credentials providers (such as <code>AssumeRoleCredentialsProvider</code>) already
have caching, while most others do not and need to be wrapped in <code>LazyCachingCredentialsProvider</code>.</p>
<p>The goal of this RFC is to create an API where Rust's type system ensures caching is set up
correctly, or explicitly opted out of.</p>
<h2 id="credentialscache-and-configloadercredentials_cache"><a class="header" href="#credentialscache-and-configloadercredentials_cache"><code>CredentialsCache</code> and <code>ConfigLoader::credentials_cache</code></a></h2>
<p>A new config method named <code>credentials_cache()</code> will be added to <code>ConfigLoader</code> and the
generated service <code>Config</code> builders that takes a <code>CredentialsCache</code> instance. This <code>CredentialsCache</code>
will be a struct with several functions on it to create and configure the cache.</p>
<p>Client creation will ultimately be responsible for taking this <code>CredentialsCache</code> instance
and wrapping the given (or default) credentials provider.</p>
<p>The <code>CredentialsCache</code> would look as follows:</p>
<pre><code class="language-rust ignore">enum Inner {
    Lazy(LazyConfig),
    // Eager doesn't exist today, so this is purely for illustration
    Eager(EagerConfig),
    // Custom may not be implemented right away
    // Not naming or specifying the custom cache trait for now since its out of scope
    Custom(Box&lt;dyn SomeCacheTrait&gt;),

    NoCaching,
}
pub struct CredentialsCache {
    inner: Inner,
}

impl CredentialsCache {
    // These methods use default cache settings
    pub fn lazy() -&gt; Self { /* ... */ }
    pub fn eager() -&gt; Self { /* ... */ }

    // Unprefixed methods return a builder that can take customizations
    pub fn lazy_builder() -&gt; LazyBuilder { /* ... */ }
    pub fn eager_builder() -&gt; EagerBuilder { /* ... */ }

    // Later, when custom implementations are supported
    pub fn custom(cache_impl: Box&lt;dyn SomeCacheTrait&gt;) -&gt; Self { /* ... */ }

    pub(crate) fn create_cache(
        self,
        provider: Box&lt;dyn ProvideCredentials&gt;,
        sleep_impl: Arc&lt;dyn AsyncSleep&gt;
    ) -&gt; SharedCredentialsProvider {
        // Note: SharedCredentialsProvider would get renamed to SharedCredentialsCache.
        // This code is using the old name to make it clearer that it already exists,
        // and the rename is called out in the change checklist.
        SharedCredentialsProvider::new(
            match self {
                Self::Lazy(inner) =&gt; LazyCachingCredentialsProvider::new(provider, settings.time, /* ... */),
                Self::Eager(_inner) =&gt; unimplemented!(),
                Self::Custom(_custom) =&gt; unimplemented!(),
                Self::NoCaching =&gt; unimplemented!(),
            }
        )
    }
}</code></pre>
<p>Using a struct over a trait prevents custom caching implementations, but if customization is desired,
a <code>Custom</code> variant could be added to the inner enum that has its own trait that customers implement.</p>
<p>The <code>SharedCredentialsProvider</code> needs to be updated to take a cache implementation in addition to
the <code>impl ProvideCredentials + 'static</code>. A sealed trait could be added to facilitate this.</p>
<p>Customers that don't care about credential caching can configure credential providers
without needing to think about it:</p>
<pre><code class="language-rust ignore">let sdk_config = aws_config::from_env()
    .credentials_provider(ImdsCredentialsProvider::builder().build())
    .load()
    .await;</code></pre>
<p>However, if they want to customize the caching, they can do so without modifying
the credentials provider at all (in case they want to use the default):</p>
<pre><code class="language-rust ignore">let sdk_config = aws_config::from_env()
    .credentials_cache(CredentialsCache::default_eager())
    .load()
    .await;</code></pre>
<p>The <code>credentials_cache</code> will default to <code>CredentialsCache::default_lazy()</code> if not provided.</p>
<h2 id="changes-checklist"><a class="header" href="#changes-checklist">Changes Checklist</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
Remove cache from <code>AssumeRoleProvider</code></li>
<li><input disabled="" type="checkbox"/>
Implement <code>CredentialsCache</code> with its <code>Lazy</code> variant and builder</li>
<li><input disabled="" type="checkbox"/>
Add <code>credentials_cache</code> method to <code>ConfigLoader</code></li>
<li><input disabled="" type="checkbox"/>
Refactor <code>ConfigLoader</code> to take <code>CredentialsCache</code> instead of <code>impl ProvideCredentials + 'static</code></li>
<li><input disabled="" type="checkbox"/>
Refactor <code>SharedCredentialsProvider</code> to take a cache implementation in addition to an <code>impl ProvideCredentials + 'static</code></li>
<li><input disabled="" type="checkbox"/>
Remove <code>ProvideCredentials</code> impl from <code>LazyCachingCredentialsProvider</code></li>
<li><input disabled="" type="checkbox"/>
Rename <code>LazyCachingCredentialsProvider</code> -&gt; <code>LazyCredentialsCache</code></li>
<li><input disabled="" type="checkbox"/>
Refactor the SDK <code>Config</code> code generator to be consistent with <code>ConfigLoader</code></li>
<li><input disabled="" type="checkbox"/>
Write changelog upgrade instructions</li>
<li><input disabled="" type="checkbox"/>
Fix examples (if there are any for configuring caching)</li>
</ul>
<h2 id="appendix-alternatives-considered"><a class="header" href="#appendix-alternatives-considered">Appendix: Alternatives Considered</a></h2>
<h3 id="alternative-a-providecachedcredentials-trait"><a class="header" href="#alternative-a-providecachedcredentials-trait">Alternative A: <code>ProvideCachedCredentials</code> trait</a></h3>
<p>In this alternative, <code>aws-types</code> has a <code>ProvideCachedCredentials</code> in addition to <code>ProvideCredentials</code>.
All individual credential providers (such as <code>ImdsCredentialsProvider</code>) implement <code>ProvideCredentials</code>,
while credential caches (such as <code>LazyCachingCredentialsProvider</code>) implement the <code>ProvideCachedCredentials</code>.
The <code>ConfigLoader</code> would only take <code>impl ProvideCachedCredentials</code>.</p>
<p>This allows customers to provide their own caching solution by implementing <code>ProvideCachedCredentials</code>,
while requiring that caching be done correctly through the type system since <code>ProvideCredentials</code> is
only useful inside the implementation of <code>ProvideCachedCredentials</code>.</p>
<p>Caching can be opted out by creating a <code>NoCacheCredentialsProvider</code> that implements <code>ProvideCachedCredentials</code>
without any caching logic, although this wouldn't be recommended and this provider wouldn't be vended
in <code>aws-config</code>.</p>
<p>Example configuration:</p>
<pre><code class="language-rust ignore">// Compiles
let sdk_config = aws_config::from_env()
    .credentials(
        LazyCachingCredentialsProvider::builder()
            .load(ImdsCredentialsProvider::new())
            .build()
    )
    .load()
    .await;

// Doesn't compile
let sdk_config = aws_config::from_env()
    // Wrong type: doesn't implement `ProvideCachedCredentials`
    .credentials(ImdsCredentialsProvider::new())
    .load()
    .await;</code></pre>
<p>Another method could be added to <code>ConfigLoader</code> that makes it easier to use the default cache:</p>
<pre><code class="language-rust ignore">let sdk_config = aws_config::from_env()
    .credentials_with_default_cache(ImdsCredentialsProvider::new())
    .load()
    .await;</code></pre>
<h4 id="proscons"><a class="header" href="#proscons">Pros/cons</a></h4>
<ul>
<li>:+1: It's flexible, and somewhat enforces correct cache setup through types.</li>
<li>:+1: Removes the possibility of double caching since the cache implementations won't
implement <code>ProvideCredentials</code>.</li>
<li>:-1: Customers may unintentionally implement <code>ProvideCachedCredentials</code> instead of <code>ProvideCredentials</code>
for a custom provider, and then not realize they're not benefiting from caching.</li>
<li>:-1: The documentation needs to make it very clear what the differences are between <code>ProvideCredentials</code>
and <code>ProvideCachedCredentials</code> since they will look identical.</li>
<li>:-1: It's possible to implement both <code>ProvideCachedCredentials</code> and <code>ProvideCredentials</code>, which
breaks the type safety goals.</li>
</ul>
<h3 id="alternative-b-cachecredentials-trait"><a class="header" href="#alternative-b-cachecredentials-trait">Alternative B: <code>CacheCredentials</code> trait</a></h3>
<p>This alternative is similar to alternative A, except that the cache trait is distinct from <code>ProvideCredentials</code> so
that it's more apparent when mistakenly implementing the wrong trait for a custom credentials provider.</p>
<p>A <code>CacheCredentials</code> trait would be added that looks as follows:</p>
<pre><code class="language-rust ignore">pub trait CacheCredentials: Send + Sync + Debug {
    async fn cached(&amp;self, now: SystemTime) -&gt; Result&lt;Credentials, CredentialsError&gt;;
}</code></pre>
<p>Instances implementing <code>CacheCredentials</code> need to own the <code>ProvideCredentials</code> implementation
to make both lazy and eager credentials caching possible.</p>
<p>The configuration examples look identical to Option A.</p>
<h4 id="proscons-1"><a class="header" href="#proscons-1">Pros/cons</a></h4>
<ul>
<li>:+1: It's flexible, and enforces correct cache setup through types slightly better than Option A.</li>
<li>:+1: Removes the possibility of double caching since the cache implementations won't
implement <code>ProvideCredentials</code>.</li>
<li>:-1: Customers can still unintentionally implement the wrong trait and miss out on caching when
creating custom credentials providers, but it will be more apparent than in Option A.</li>
<li>:-1: It's possible to implement both <code>CacheCredentials</code> and <code>ProvideCredentials</code>, which
breaks the type safety goals.</li>
</ul>
<h3 id="alternative-c-credentialscache-struct-with-composition"><a class="header" href="#alternative-c-credentialscache-struct-with-composition">Alternative C: <code>CredentialsCache</code> struct with composition</a></h3>
<p>The struct approach posits that customers don't need or want to implement custom credential caching,
but at the same time, doesn't make it impossible to add custom caching later.</p>
<p>The idea is that there would be a struct called <code>CredentialsCache</code> that specifies the desired
caching approach for a given credentials provider:</p>
<pre><code class="language-rust ignore">pub struct LazyCache {
    credentials_provider: Arc&lt;dyn ProvideCredentials&gt;,
    // ...
}

pub struct EagerCache {
    credentials_provider: Arc&lt;dyn ProvideCredentials&gt;,
    // ...
}

pub struct CustomCache {
    credentials_provider: Arc&lt;dyn ProvideCredentials&gt;,
    // Not naming or specifying the custom cache trait for now since its out of scope
    cache: Arc&lt;dyn SomeCacheTrait&gt;
}

enum CredentialsCacheInner {
    Lazy(LazyCache),
    // Eager doesn't exist today, so this is purely for illustration
    Eager(EagerCache),
    // Custom may not be implemented right away
    Custom(CustomCache),
}

pub struct CredentialsCache {
    inner: CredentialsCacheInner,
}

impl CredentialsCache {
    // Methods prefixed with `default_` just use the default cache settings
    pub fn default_lazy(provider: impl ProvideCredentials + 'static) -&gt; Self { /* ... */ }
    pub fn default_eager(provider: impl ProvideCredentials + 'static) -&gt; Self { /* ... */ }

    // Unprefixed methods return a builder that can take customizations
    pub fn lazy(provider: impl ProvideCredentials + 'static) -&gt; LazyBuilder { /* ... */ }
    pub fn eager(provider: impl ProvideCredentials + 'static) -&gt; EagerBuilder { /* ... */ }

    pub(crate) fn create_cache(
        self,
        sleep_impl: Arc&lt;dyn AsyncSleep&gt;
    ) -&gt; SharedCredentialsProvider {
        // ^ Note: SharedCredentialsProvider would get renamed to SharedCredentialsCache.
        // This code is using the old name to make it clearer that it already exists,
        // and the rename is called out in the change checklist.
        SharedCredentialsProvider::new(
            match self {
                Self::Lazy(inner) =&gt; LazyCachingCredentialsProvider::new(inner.credentials_provider, settings.time, /* ... */),
                Self::Eager(_inner) =&gt; unimplemented!(),
                Self::Custom(_custom) =&gt; unimplemented!(),
            }
        )
    }
}</code></pre>
<p>Using a struct over a trait prevents custom caching implementations, but if customization is desired,
a <code>Custom</code> variant could be added to the inner enum that has its own trait that customers implement.</p>
<p>The <code>SharedCredentialsProvider</code> needs to be updated to take a cache implementation rather
than <code>impl ProvideCredentials + 'static</code>. A sealed trait could be added to facilitate this.</p>
<p>Configuration would look as follows:</p>
<pre><code class="language-rust ignore">let sdk_config = aws_config::from_env()
    .credentials(CredentialsCache::default_lazy(ImdsCredentialsProvider::builder().build()))
    .load()
    .await;</code></pre>
<p>The <code>credentials_provider</code> method on <code>ConfigLoader</code> would only take <code>CredentialsCache</code> as an argument
so that the SDK could not be configured without credentials caching, or if opting out of caching becomes
a use case, then a <code>CredentialsCache::NoCache</code> variant could be made.</p>
<p>Like alternative A, a convenience method can be added to make using the default cache easier:</p>
<pre><code class="language-rust ignore">let sdk_config = aws_config::from_env()
    .credentials_with_default_cache(ImdsCredentialsProvider::builder().build())
    .load()
    .await;</code></pre>
<p>In the future if custom caching is added, it would look as follows:</p>
<pre><code class="language-rust ignore">let sdk_config = aws_config::from_env()
    .credentials(
        CredentialsCache::custom(ImdsCredentialsProvider::builder().build(), MyCache::new())
    )
    .load()
    .await;</code></pre>
<p>The <code>ConfigLoader</code> wouldn't be able to immediately set its credentials provider since other values
from the config are needed to construct the cache (such as <code>sleep_impl</code>). Thus, the <code>credentials</code>
setter would merely save off the <code>CredentialsCache</code> instance, and then when <code>load</code> is called,
the complete <code>SharedCredentialsProvider</code> would be constructed:</p>
<pre><code class="language-rust ignore">pub async fn load(self) -&gt; SdkConfig {
    // ...
    let credentials_provider = self.credentials_cache.create_cache(sleep_impl);
    // ...
}</code></pre>
<h4 id="proscons-2"><a class="header" href="#proscons-2">Pros/cons</a></h4>
<ul>
<li>:+1: Removes the possibility of missing out on caching when implementing a custom provider.</li>
<li>:+1: Removes the possibility of double caching since the cache implementations won't
implement <code>ProvideCredentials</code>.</li>
<li>:-1: Requires thinking about caching when only wanting to customize the credentials provider</li>
<li>:-1: Requires a lot of boilerplate in <code>aws-config</code> for the builders, enum variant structs, etc.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rfcs/rfc0027_endpoints_20.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../rfcs/rfc0029_new_home_for_cred_types.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rfcs/rfc0027_endpoints_20.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../rfcs/rfc0029_new_home_for_cred_types.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../static/mermaid.min.js"></script>
        <script src="../static/mermaid-init.js"></script>


    </div>
    </body>
</html>
