<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RFC-0027: Endpoints 2.0 - Smithy Rust</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">1.</strong> Design Overview</a></li><li class="chapter-item expanded "><a href="../tenets.html"><strong aria-hidden="true">2.</strong> Tenets</a></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">3.</strong> Design FAQ</a></li><li class="chapter-item expanded "><a href="../transport/overview.html"><strong aria-hidden="true">4.</strong> Transport</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../transport/operation.html"><strong aria-hidden="true">4.1.</strong> HTTP Operations</a></li><li class="chapter-item expanded "><a href="../transport/middleware.html"><strong aria-hidden="true">4.2.</strong> HTTP Middleware</a></li><li class="chapter-item expanded "><a href="../transport/connector.html"><strong aria-hidden="true">4.3.</strong> TLS Connector</a></li></ol></li><li class="chapter-item expanded "><a href="../smithy/overview.html"><strong aria-hidden="true">5.</strong> Smithy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../smithy/simple_shapes.html"><strong aria-hidden="true">5.1.</strong> Simple Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/recursive_shapes.html"><strong aria-hidden="true">5.2.</strong> Recursive Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/aggregate_shapes.html"><strong aria-hidden="true">5.3.</strong> Aggregate Shapes</a></li><li class="chapter-item expanded "><a href="../smithy/endpoint.html"><strong aria-hidden="true">5.4.</strong> Endpoint Resolution</a></li><li class="chapter-item expanded "><a href="../smithy/backwards-compat.html"><strong aria-hidden="true">5.5.</strong> Backwards Compatibility</a></li></ol></li><li class="chapter-item expanded "><a href="../client/overview.html"><strong aria-hidden="true">6.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../client/orchestrator.html"><strong aria-hidden="true">6.1.</strong> What is the 'orchestrator' and why does it exist?</a></li><li class="chapter-item expanded "><a href="../client/identity_and_auth.html"><strong aria-hidden="true">6.2.</strong> Identity and Auth</a></li></ol></li><li class="chapter-item expanded "><a href="../server/overview.html"><strong aria-hidden="true">7.</strong> Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server/middleware.html"><strong aria-hidden="true">7.1.</strong> Middleware</a></li><li class="chapter-item expanded "><a href="../server/instrumentation.html"><strong aria-hidden="true">7.2.</strong> Instrumentation</a></li><li class="chapter-item expanded "><a href="../server/from_parts.html"><strong aria-hidden="true">7.3.</strong> Accessing Un-modelled Data</a></li><li class="chapter-item expanded "><a href="../server/anatomy.html"><strong aria-hidden="true">7.4.</strong> The Anatomy of a Service</a></li><li class="chapter-item expanded "><a href="../server/code_generation.html"><strong aria-hidden="true">7.5.</strong> Generating Common Service Code</a></li></ol></li><li class="chapter-item expanded "><a href="../rfcs/overview.html"><strong aria-hidden="true">8.</strong> RFCs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rfcs/rfc0001_shared_config.html"><strong aria-hidden="true">8.1.</strong> RFC-0001: Sharing configuration between multiple clients</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0002_http_versions.html"><strong aria-hidden="true">8.2.</strong> RFC-0002: Supporting multiple HTTP versions for SDKs that use Event Stream</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0003_presigning_api.html"><strong aria-hidden="true">8.3.</strong> RFC-0003: API for Pre-signed URLs</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0004_retry_behavior.html"><strong aria-hidden="true">8.4.</strong> RFC-0004: Retry Behavior</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0005_service_generation.html"><strong aria-hidden="true">8.5.</strong> RFC-0005: Smithy Rust service framework</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0006_service_specific_middleware.html"><strong aria-hidden="true">8.6.</strong> RFC-0006: Service-specific middleware</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0007_split_release_process.html"><strong aria-hidden="true">8.7.</strong> RFC-0007: Split release process</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0008_paginators.html"><strong aria-hidden="true">8.8.</strong> RFC-0008: Paginators</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0009_example_consolidation.html"><strong aria-hidden="true">8.9.</strong> RFC-0009: Example Consolidation</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0010_waiters.html"><strong aria-hidden="true">8.10.</strong> RFC-0010: Waiters</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0011_crates_io_alpha_publishing.html"><strong aria-hidden="true">8.11.</strong> RFC-0011: Publishing Alpha to Crates.io</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0012_independent_crate_versioning.html"><strong aria-hidden="true">8.12.</strong> RFC-0012: Independent Crate Versioning</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0013_body_callback_apis.html"><strong aria-hidden="true">8.13.</strong> RFC-0013: Body Callback APIs</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0014_timeout_config.html"><strong aria-hidden="true">8.14.</strong> RFC-0014: Fine-grained timeout configuration</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0015_using_features_responsibly.html"><strong aria-hidden="true">8.15.</strong> RFC-0015: How Cargo "features" should be used in the SDK and runtime crates</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0016_flexible_checksum_support.html"><strong aria-hidden="true">8.16.</strong> RFC-0016: Supporting Flexible Checksums</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0017_customizable_client_operations.html"><strong aria-hidden="true">8.17.</strong> RFC-0017: Customizable Client Operations</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0018_logging_sensitive.html"><strong aria-hidden="true">8.18.</strong> RFC-0018: Logging in the Presence of Sensitive Data</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0019_event_streams_errors.html"><strong aria-hidden="true">8.19.</strong> RFC-0019: Event Streams Errors</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0020_service_builder.html"><strong aria-hidden="true">8.20.</strong> RFC-0020: Service Builder Improvements</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0021_dependency_versions.html"><strong aria-hidden="true">8.21.</strong> RFC-0021: Dependency Versions</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0022_error_context_and_compatibility.html"><strong aria-hidden="true">8.22.</strong> RFC-0022: Error Context and Compatibility</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0023_refine_builder.html"><strong aria-hidden="true">8.23.</strong> RFC-0023: Evolving the new service builder API</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0024_request_id.html"><strong aria-hidden="true">8.24.</strong> RFC-0024: RequestID</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0025_constraint_traits.html"><strong aria-hidden="true">8.25.</strong> RFC-0025: Constraint traits</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0026_client_crate_organization.html"><strong aria-hidden="true">8.26.</strong> RFC-0026: Client Crate Organization</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0027_endpoints_20.html" class="active"><strong aria-hidden="true">8.27.</strong> RFC-0027: Endpoints 2.0</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0028_sdk_credential_cache_type_safety.html"><strong aria-hidden="true">8.28.</strong> RFC-0028: SDK Credential Cache Type Safety</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0029_new_home_for_cred_types.html"><strong aria-hidden="true">8.29.</strong> RFC-0029: Finding New Home for Credential Types</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0030_serialization_and_deserialization.html"><strong aria-hidden="true">8.30.</strong> RFC-0030: Serialization And Deserialization</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0031_providing_fallback_credentials_on_timeout.html"><strong aria-hidden="true">8.31.</strong> RFC-0031: Providing Fallback Credentials on Timeout</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0032_better_constraint_violations.html"><strong aria-hidden="true">8.32.</strong> RFC-0032: Better Constraint Violations</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0033_improve_sdk_request_id_access.html"><strong aria-hidden="true">8.33.</strong> RFC-0033: Improving access to request IDs in SDK clients</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0034_smithy_orchestrator.html"><strong aria-hidden="true">8.34.</strong> RFC-0034: Smithy Orchestrator</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0035_collection_defaults.html"><strong aria-hidden="true">8.35.</strong> RFC-0035: Collection Defaults</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0036_http_dep_elimination.html"><strong aria-hidden="true">8.36.</strong> RFC-0036: HTTP Dependency Exposure</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0037_http_wrapper.html"><strong aria-hidden="true">8.37.</strong> RFC-0037: The HTTP Wrapper</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0038_retry_classifier_customization.html"><strong aria-hidden="true">8.38.</strong> RFC-0038: User-configurable retry classification</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0039_forward_compatible_errors.html"><strong aria-hidden="true">8.39.</strong> RFC-0039: Forward Compatible Errors</a></li><li class="chapter-item expanded "><a href="../rfcs/rfc0040_behavior_major_versions.html"><strong aria-hidden="true">8.40.</strong> RFC-0040: Behavior Major Versions</a></li></ol></li><li class="chapter-item expanded "><a href="../contributing/overview.html"><strong aria-hidden="true">9.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contributing/writing_and_debugging_a_low-level_feature_that_relies_on_HTTP.html"><strong aria-hidden="true">9.1.</strong> Writing and debugging a low-level feature that relies on HTTP</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Smithy Rust</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Give your RFC a descriptive name saying what it would accomplish or what feature it defines -->
<h1 id="rfc-endpoints-20"><a class="header" href="#rfc-endpoints-20">RFC: Endpoints 2.0</a></h1>
<!-- RFCs start with the "RFC" status and are then either "Implemented" or "Rejected".  -->
<blockquote>
<p>Status: RFC</p>
</blockquote>
<!-- A great RFC will include a list of changes at the bottom so that the implementor can be sure they haven't missed anything -->
<p>For a summarized list of proposed changes, see the <a href="#changes-checklist">Changes Checklist</a> section.</p>
<!-- Insert a short paragraph explaining, at a high level, what this RFC is for -->
<p>This RFC defines how the Rust SDK will integrate with the next generation of endpoint resolution logic (Endpoints 2.0).
Endpoints 2.0 defines a rules language for resolving endpoints. The Rust SDK will code-generate Rust code from this
intermediate language and use this to create service-specific endpoint resolvers.</p>
<p>Endpoints 2.0 will be a core feature and be available for generic clients as well as the AWS SDK.</p>
<!-- The "Terminology" section is optional but is really useful for defining the technical terms you're using in the RFC -->
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<ul>
<li><strong>Generic client</strong>: In reference to features/code that is <em>not</em> AWS specific and is supported for all Smithy clients.</li>
<li><strong>Rules language</strong>: A JSON-based rules language used to resolve endpoints</li>
<li><a href="#the-endpoint-struct"><strong>Smithy Endpoint</strong></a>: An endpoint, as returned from the rules-language. This contains a URI,
headers, and configuration map of <code>String -&gt; Document</code> (<code>properties</code>). This must
undergo <a href="#converting-a-smithy-endpoint-to-an-aws-endpoint">another level of transformation</a> before it
can be used as an <code>AwsEndpoint</code>.</li>
<li><strong>AWS Endpoint</strong>: An endpoint with explicit signing configuration applied. AWS Endpoints need to contain region &amp;
service metadata to control signing.</li>
<li><strong>Middleware</strong>: A transformation applied to a request, prior to request dispatch</li>
<li><strong>Endpoint Parameters</strong>: A code-generated structure for each service which contains service-specific (and general)
endpoint parameters.</li>
</ul>
<!-- Explain how users will use this new feature and, if necessary, how this compares to the current user experience -->
<h2 id="the-user-experience-if-this-rfc-is-implemented"><a class="header" href="#the-user-experience-if-this-rfc-is-implemented">The user experience if this RFC is implemented</a></h2>
<h3 id="overview"><a class="header" href="#overview">Overview</a></h3>
<p>SDKs will generate a new, public, <code>endpoint</code> module. The module will contain a <a href="#endpoint-params"><code>Params</code></a> structure
and
a <a href="#the-default-endpoint-resolver"><code>DefaultResolver</code></a>. Supporting these modules, a private <code>endpoints_impl</code> module will
be generated.</p>
<blockquote>
<p><strong>Why generate two modules</strong>?</p>
<p>Generating two separate modules, <code>endpoint</code> and <code>endpoint_impl</code> ensures that we don't have namespace collisions
between hand-written and generated
code.</p>
</blockquote>
<p>SDK middleware will be updated to use the new <a href="#the-endpoint-struct"><code>smithy_types::Endpoint</code></a>. During request
construction in <code>make_operation</code>, a <a href="#the-endpoint-struct">smithy endpoint</a> will be inserted into the property bag. The
endpoint middleware will be updated to extract the Smithy endpoint from the property bag and set the request endpoint &amp;
signing information accordingly (see: <a href="#converting-a-smithy-endpoint-to-an-aws-endpoint">Converting to AWS Endpoint</a>.</p>
<p>The following flow chart traces the endpoints 2.0 influence on a request via the green boxes.</p>
<pre class="mermaid">flowchart TD
    globalConfig(&quot;SDK global configuration (e.g. region provider, UseFIPS, etc.)&quot;)

    serviceConfig(&quot;Modeled, service specific configuration information (clientContextParams)&quot;)

    operationConfig(&quot;Operation-specific configuration (S3 Bucket, accountId, etc.)&quot;)

    getObject[&quot;S3::GetObject&quot;]

    params[&quot;Create endpoint parameters&quot;]

    evaluate[&quot;Evaluate ruleset&quot;]

    rules[&quot;Generated Endpoint Ruleset for S3&quot;]

    middleware[&quot;Apply endpoint &amp; properties to request via endpoint middleware&quot;]



    style getObject fill:green,stroke:#333,stroke-width:4px
    style params fill:green,stroke:#333,stroke-width:4px
    style evaluate fill:green,stroke:#333,stroke-width:4px
    style middleware fill:green,stroke:#333,stroke-width:4px

    getObject ==&gt; params
    globalConfig ---&gt; params
    operationConfig --&gt; params
    serviceConfig ---&gt; params

    rules --&gt; evaluate
    params --&gt; evaluate
    evaluate --&gt; middleware
</pre>
<h3 id="overriding-endpoints"><a class="header" href="#overriding-endpoints">Overriding Endpoints</a></h3>
<p>In the general case, users will not be impacted by Endpoints 2.0 with one exception: today, users can provide a
global endpoint provider that can override different services. There is a single <code>ResolveAwsEndpoint</code> trait that
is shared across all services. However, this isn't the case for <code>Endpoints 2.0</code> where the trait actually has a generic
parameter:</p>
<pre><code class="language-rust ignore">pub trait ResolveEndpoint&lt;T&gt;: Send + Sync {
    fn resolve_endpoint(&amp;self, params: &amp;T) -&gt; Result&lt;Endpoint, BoxError&gt;;
}</code></pre>
<p>The trait itself would then be parameterized by service-specific endpoint parameter, eg:
<code>aws_sdk_s3::endpoint::Params</code>. The endpoint parameters we would use for S3 (e.g. including <code>Bucket</code>) are different
from the endpoint parameters we might use for a service like DynamoDB which, today, doesn't have any custom endpoint
behavior.</p>
<p>Going forward we will to provide two different avenues for customers to customize endpoints:</p>
<ol>
<li>Configuration driven URL override. This mechanism hasn't been specified, but suppose that the Rust SDK supported
an <code>SDK_ENDPOINT</code> environment variable. This variable would be an input to the existing endpoint resolver.
machinery and would be backwards compatible with other SDKs (e.g. by prefixing the bucket as a host label for S3).</li>
<li>Wholesale endpoint resolver override. In this case, customers would gain access to all endpoint parameters and be
able to write their own resolver.</li>
</ol>
<p>This RFC proposes making the following changes:</p>
<ol>
<li>For the current <em>global</em> ability to override an endpoint, instead of accepting an <code>AwsEndpoint</code>, accept a URI. This
will simplify the interface for most customers who don't actually need logic-driven endpoint construction. The
Endpoint that can be set will be passed in as the <code>SDK::Endpoint</code> built-in. This will be renamed to <code>endpoint_url</code>
for clarity. <strong>All</strong> AWS services <strong>MUST</strong> accept the <code>SDK::Endpoint</code> built-in.</li>
<li>For complex, service-specific behavior, customers will be able to provide a service specific endpoint resolver at
client construction time. This resolver will be parameterized with the service-specific parameters type, (
eg. <code>aws_sdk_s3::endpoint::Params</code>). Finally, customers will be able to access the <code>default_resolver()</code> for AWS
services directly. This will enable them to utilize the default S3 endpoint resolver in their resolver
implementation.</li>
</ol>
<p><strong>Example: overriding the endpoint URI globally</strong></p>
<pre><code class="language-rust ignore">async fn main() {
    let sdk_conf = aws_config::from_env().endpoint_url(&quot;http://localhost:8123&quot;).load().await;
    let dynamo = aws_sdk_dynamodb::Client::new(&amp;sdk_conf);
    // snip ...
}</code></pre>
<p><strong>Example: overriding the endpoint resolver for a service</strong></p>
<pre><code class="language-rust ignore">/// Resolve to Localhost when an environment variable is set
struct CustomDdbResolver;

impl ResolveEndpoint&lt;aws_sdk_dynamodb::endpoint::Params&gt; for CustomDdbResolver {
    fn resolve_endpoint(&amp;self, params: &amp;Params) -&gt; Result&lt;Endpoint, EndpointResolutionError&gt; {
        // custom resolver to redirect to DDB local if a flag is set
        let base_endpoint = aws_sdk_dynamodb::endpoint::default_resolver().resolve_endpoint(params).expect(&quot;valid endpoint should be resolved&quot;);
        if env::var(&quot;LOCAL&quot;) == Ok(&quot;true&quot;) {
            // update the URI on the returned endpoint to localhost while preserving the other properties
            Ok(base_endpoint.builder().uri(&quot;http://localhost:8888&quot;).build())
        } else {
            Ok(base_endpoint)
        }
    }
}

async fn main() {
    let conf = aws_config::load_from_env().await;
    let ddb_conf = aws_sdk_dynamodb::config::Builder::from(&amp;conf).endpoint_resolver(CustomDdbResolver);
    let dynamodb = aws_sdk_dynamodb::Client::from_conf(ddb_conf);
}</code></pre>
<p>Note: for generic clients, they cannot use <code>endpoint_url</code>â€”this is because <code>endpoint_url</code> is dependent on rules and
generic
clients do not necessarily rules. However, they can use the <code>impl&lt;T&gt; ResolveEndpoint&lt;T&gt; for &amp;'static str { ... }</code>
implementation.</p>
<blockquote>
<p><strong>What about alternative S3 implementations? How do we say &quot;don't put prefix bucket on this?&quot;</strong></p>
<p>For cases where users want to use the provided URL directly with no modification users will need to rely on service
specific configuration, like forcing path style addressing for S3.</p>
</blockquote>
<p><em>Alternative Design</em>: <a href="#context-aware-endpoint-traits">Context Aware Endpoint Trait</a></p>
<blockquote>
<p><em>Optional addition</em>: We could add an additional <code>EndpointResolver</code> parameter to <code>SdkConfig</code> that exposed a global
trait
where <code>Params</code> is <code>&amp;dyn Any</code> similar to <a href="#context-aware-endpoint-traits">Context Aware Endpoint Trait</a>. If these were
<strong>both</strong> set, a runtime panic would alert users to the misconfiguration.</p>
</blockquote>
<h3 id="new-endpoint-traits"><a class="header" href="#new-endpoint-traits">New Endpoint Traits</a></h3>
<p>The new endpoint resolution trait and <code>Endpoint</code> struct will be available for generic clients. AWS endpoint middleware
will pull the <code>Endpoint</code> out of the property bag and read the properties to determine auth/signing + any other AWS
metadata that may be required.</p>
<p>An example of the <code>Endpoint</code> struct is below. This struct will be in <code>aws-smithy-types</code>, however, it should initially be
gated with documentation warning about stability.</p>
<h4 id="the-endpoint-struct"><a class="header" href="#the-endpoint-struct">The Endpoint Struct</a></h4>
<pre><code class="language-rust ignore">// module: `aws_smithy_types::endpoint`
// potential optimization to reduce / remove allocations for keys which are almost always static
// this can also just be `String`
type MaybeStatic&lt;T&gt; = Cow&lt;'static, T&gt;;

/// Endpoint
#[derive(Debug, PartialEq)]
pub struct Endpoint {
    // Note that this allows `Endpoint` to contain an invalid URI. During conversion to an actual endpoint, the
    // the middleware can fail, returning a `ConstructionFailure` to the user
    url: MaybeStatic&lt;str&gt;,
    headers: HashMap&lt;MaybeStatic&lt;str&gt;, Vec&lt;MaybeStatic&lt;str&gt;&gt;&gt;,
    properties: HashMap&lt;MaybeStatic&lt;str&gt;, aws_smithy_types::Document&gt;,
}

// not shown:
// - impl block with standard accessors
// - builder, designed to be invoked / used by generated code</code></pre>
<blockquote>
<p><strong>What's an Endpoint property?</strong></p>
<p>Endpoint properties, on their own, have no intrinsic meaning. Endpoint properties have established conventions for AWS
SDKs. Other Smithy implementors may choose a different pattern. For AWS SDKs, the <code>authSchemes</code> key is an ordered list
of authentication/signing schemes supported by the Endpoint that the SDK should use.</p>
</blockquote>
<p>To perform produce an <code>Endpoint</code> struct we have a generic <code>ResolveEndpoint</code> trait which will be both generic in terms of
parameters and being &quot;smithy-generic:</p>
<pre><code class="language-rust ignore">// module: `smithy_types::endpoint` or `aws_smithy_client`??
pub trait ResolveEndpoint&lt;Params&gt;: Send + Sync {
    /// Resolves an `Endpoint` for `Params`
    fn resolve_endpoint(&amp;self, params: &amp;Params) -&gt; Result&lt;aws_smithy_types::Endpoint, EndpointResolutionError&gt;;
}</code></pre>
<p>All Smithy services that have the <code>@endpointRuleSet</code> trait applied to the service shape will code generate a default
endpoint resolver implementation. The default endpoint resolver <strong>MUST</strong> be public, so that customers can delegate to it
if they wish to override the endpoint resolver.</p>
<h3 id="endpoint-params"><a class="header" href="#endpoint-params">Endpoint Params</a></h3>
<p>We've mentioned &quot;service specific endpoint parameters&quot; a few times. In Endpoints 2.0, we will code generate Endpoint
Parameters for every service based on their rules. <strong>Note</strong>: the endpoint parameters themselves are generated solely
from the ruleset. The Smithy model provides additional information about parameter binding, but that only influences how
the parameters are set, <em>not</em> how they are generated.</p>
<p><strong>Example <code>Params</code> struct for S3:</strong></p>
<pre><code class="language-rust ignore">#[non_exhaustive]
#[derive(std::clone::Clone, std::cmp::PartialEq, std::fmt::Debug)]
/// Configuration parameters for resolving the correct endpoint
pub struct Params {
    pub(crate) bucket: std::option::Option&lt;std::string::String&gt;,
    pub(crate) region: std::option::Option&lt;std::string::String&gt;,
    pub(crate) use_fips: bool,
    pub(crate) use_dual_stack: bool,
    pub(crate) endpoint: std::option::Option&lt;std::string::String&gt;,
    pub(crate) force_path_style: std::option::Option&lt;bool&gt;,
    pub(crate) accelerate: bool,
    pub(crate) disable_access_points: std::option::Option&lt;bool&gt;,
    pub(crate) disable_mrap: std::option::Option&lt;bool&gt;,
}

impl Params {
    /// Create a builder for [`Params`]
    pub fn builder() -&gt; crate::endpoint_resolver::Builder {
        crate::endpoint_resolver::Builder::default()
    }
    /// Gets the value for bucket
    pub fn bucket(&amp;self) -&gt; std::option::Option&lt;&amp;str&gt; {
        self.bucket.as_deref()
    }
    /// Gets the value for region
    pub fn region(&amp;self) -&gt; std::option::Option&lt;&amp;str&gt; {
        self.region.as_deref()
    }
    /// Gets the value for use_fips
    pub fn use_fips(&amp;self) -&gt; std::option::Option&lt;bool&gt; {
        Some(self.use_fips)
    }
    /// Gets the value for use_dual_stack
    pub fn use_dual_stack(&amp;self) -&gt; std::option::Option&lt;bool&gt; {
        Some(self.use_dual_stack)
    }
    // ... more accessors
}</code></pre>
<h3 id="the-default-endpoint-resolver"><a class="header" href="#the-default-endpoint-resolver">The default endpoint resolver</a></h3>
<p>When an endpoint ruleset is present, Smithy will code generate an endpoint resolver from that ruleset. The endpoint
resolver
<strong>MUST</strong> be a struct so that it can store/cache computations (such as a partition resolver that has compiled regexes).</p>
<pre><code class="language-rust ignore">pub struct DefaultEndpointResolver {
    partition_resolver: PartitionResolver
}

impl ResolveEndpoint&lt;crate::endpoint::Params&gt; for DefaultEndpointResolver {
    fn resolve_endpoint(&amp;self, params: &amp;Params) -&gt; Result&lt;aws_smithy_types::Endpoint, EndpointResolutionError&gt; {
        // delegate to private impl
        crate::endpoints_impl::resolve_endpoint(params)
    }
}</code></pre>
<p><code>DefaultEndpointResolver</code> <strong>MUST</strong> be publicly accessible and offer both a default constructor and the ability to
configure resolution behavior (e.g. by supporting adding additional partitions.)</p>
<h2 id="how-to-actually-implement-this-rfc"><a class="header" href="#how-to-actually-implement-this-rfc">How to actually implement this RFC</a></h2>
<p>To describe how this feature will work, let's take a step-by-step path through endpoint resolution.</p>
<ol>
<li>
<p>A user defines a service client, possibly with some client specific configuration like region.</p>
<blockquote>
<p><code>@clientContextParams</code> are code generated onto the client <code>Config</code>
. <a href="#code-generating-client-context-params">Code generating <code>@clientContextParams</code></a></p>
</blockquote>
</li>
<li>
<p>A user invokes an operation like <code>s3::GetObject</code>. A <a href="#creating-params">params object is created</a>. In the body
of <code>make_operation()</code>, this is passed to <code>config.endpoint_resolver</code> to load a generic endpoint. The <code>Result</code> of the
of the endpoint resolution is written into the property bag.</p>
</li>
<li>
<p>The generic smithy middleware (<code>SmithyEndpointStage</code>) sets the request endpoint.</p>
</li>
<li>
<p>The AWS auth middleware (<code>AwsAuthStage</code>) reads the endpoint out of the property bag and applies signing overrides.</p>
</li>
<li>
<p>The request is signed &amp; dispatched</p>
</li>
</ol>
<p>The other major piece of implementation required is actually implementing the rules engine. To learn more about
rules-engine internals, skip to <a href="#implementing-the-rules-engine">implementing the rules engine</a>.</p>
<h3 id="code-generating-client-context-params"><a class="header" href="#code-generating-client-context-params">Code generating client context params</a></h3>
<p>When a smithy model uses the <code>@clientContextParams</code> trait, we need to generate client params onto the Rust SDK. This is
a <strong>Smithy-native</strong> feature. This should be implemented as a &quot;standard&quot; config decorator that reads traits from the
current model.</p>
<details>
<summary>Kotlin Snippet for Client context params</summary>
<pre><code class="language-kotlin">class ClientContextDecorator(ctx: ClientCodegenContext) : NamedSectionGenerator&lt;ServiceConfig&gt;() {
    private val contextParams = ctx.serviceShape.getTrait&lt;ClientContextParamsTrait&gt;()?.parameters.orEmpty().toList()
        .map { (key, value) -&gt; ContextParam.fromClientParam(key, value, ctx.symbolProvider) }

    data class ContextParam(val name: String, val type: Symbol, val docs: String?) {
        companion object {
            private fun toSymbol(shapeType: ShapeType, symbolProvider: RustSymbolProvider): Symbol =
                symbolProvider.toSymbol(
                    when (shapeType) {
                        ShapeType.STRING -&gt; StringShape.builder().id(&quot;smithy.api#String&quot;).build()
                        ShapeType.BOOLEAN -&gt; BooleanShape.builder().id(&quot;smithy.api#Boolean&quot;).build()
                        else -&gt; TODO(&quot;unsupported type&quot;)
                    }
                )

            fun fromClientParam(
                name: String,
                definition: ClientContextParamDefinition,
                symbolProvider: RustSymbolProvider
            ): ContextParam {
                return ContextParam(
                    RustReservedWords.escapeIfNeeded(name.toSnakeCase()),
                    toSymbol(definition.type, symbolProvider),
                    definition.documentation.orNull()
                )
            }
        }
    }

    override fun section(section: ServiceConfig): Writable {
        return when (section) {
            is ServiceConfig.ConfigStruct -&gt; writable {
                contextParams.forEach { param -&gt;
                    rust(&quot;pub (crate) ${param.name}: #T,&quot;, param.type.makeOptional())
                }
            }
            ServiceConfig.ConfigImpl -&gt; emptySection
            ServiceConfig.BuilderStruct -&gt; writable {
                contextParams.forEach { param -&gt;
                    rust(&quot;${param.name}: #T,&quot;, param.type.makeOptional())
                }
            }
            ServiceConfig.BuilderImpl -&gt; writable {
                contextParams.forEach { param -&gt;
                    param.docs?.also { docs(it) }
                    rust(
                        &quot;&quot;&quot;
                        pub fn ${param.name}(mut self, ${param.name}: #T) -&gt; Self {
                            self.${param.name} = Some(${param.name});
                            self
                        }
                        &quot;&quot;&quot;,
                        param.type
                    )
                }
            }
            ServiceConfig.BuilderBuild -&gt; writable {
                contextParams.forEach { param -&gt;
                    rust(&quot;${param.name}: self.${param.name},&quot;)
                }
            }
            else -&gt; emptySection
        }
    }
}
</code></pre>
</details>
<h3 id="creating-params"><a class="header" href="#creating-params">Creating <code>Params</code></a></h3>
<p><code>Params</code> will be created and utilized in generic code generation.</p>
<p><code>make_operation()</code> needs to load the parameters from several configuration sources. These sources have a priority order.
To handle this priority order, we will load from all sources in reverse priority order, with lower priority sources
overriding higher priority ones.</p>
<details>
<summary>Implementation of operation decorator</summary>
<pre><code class="language-kotlin">class EndpointParamsDecorator(
    private val ctx: ClientCodegenContext,
    private val operationShape: OperationShape,
) : OperationCustomization() {
    val idx = ContextIndex.of(ctx.model)
    private val ruleset = EndpointRuleset.fromNode(ctx.serviceShape.expectTrait&lt;EndpointRuleSetTrait&gt;().ruleSet)

    override fun section(section: OperationSection): Writable {
        return when (section) {
            is OperationSection.MutateInput -&gt; writable {
                rustTemplate(
                    &quot;&quot;&quot;
                    let params = #{Params}::builder()
                        #{builder:W}.expect(&quot;invalid endpoint&quot;);
                    &quot;&quot;&quot;,
                    &quot;Params&quot; to EndpointParamsGenerator(ruleset).paramsStruct(),
                    &quot;builder&quot; to builderFields(section)
                )
            }
            is OperationSection.MutateRequest -&gt; writable {
                rust(&quot;// ${section.request}.properties_mut().insert(params);&quot;)
            }
            else -&gt; emptySection
        }
    }

    private fun builderFields(section: OperationSection.MutateInput) = writable {
        val memberParams = idx.getContextParams(operationShape)
        val builtInParams = ruleset.parameters.toList().filter { it.isBuiltIn }
        // first load builtins and their defaults
        builtInParams.forEach { param -&gt;
            val defaultProviders = section.endpointCustomizations.mapNotNull { it.defaultFor(param, section.config) }
            if (defaultProviders.size &gt; 1) {
                error(&quot;Multiple providers provided a value for the builtin $param&quot;)
            }
            defaultProviders.firstOrNull()?.also { defaultValue -&gt;
                rust(&quot;.set_${param.name.rustName()}(#W)&quot;, defaultValue)
            }
        }
        // these can be overridden with client context params
        idx.getClientContextParams(ctx.serviceShape).forEach { (name, _param) -&gt;
            rust(&quot;.set_${name.toSnakeCase()}(${section.config}.${name.toSnakeCase()}.as_ref())&quot;)
        }

        // lastly, allow these to be overridden by members
        memberParams.forEach { (memberShape, param) -&gt;
            rust(&quot;.set_${param.name.toSnakeCase()}(${section.input}.${ctx.symbolProvider.toMemberName(memberShape)}.as_ref())&quot;)
        }
        rust(&quot;.build()&quot;)
    }
}
</code></pre>
</details>
<h4 id="loading-values-for-builtins"><a class="header" href="#loading-values-for-builtins">Loading values for builtIns</a></h4>
<p>The fundamental point of builtIn values is enabling <em>other</em> code generators to define where these values come from.
Because of that, we will need to expose the ability to customize AwsBuiltIns. One way to do this is with a new
customization type, <code>EndpointCustomization</code>:</p>
<pre><code class="language-kotlin">fun endpointCustomizations(
    clientCodegenContext: C,
    operation: OperationShape,
    baseCustomizations: List&lt;EndpointCustomization&gt;
): List&lt;EndpointCustomization&gt; = baseCustomizations


abstract class EndpointCustomization {
    abstract fun defaultFor(parameter: Parameter, config: String): Writable?
}
</code></pre>
<p>Customizations have the ability to specify the default value for a parameter. (Of course, these customizations need to
be wired in properly.)</p>
<h3 id="converting-a-smithy-endpoint-to-an-aws-endpoint"><a class="header" href="#converting-a-smithy-endpoint-to-an-aws-endpoint">Converting a Smithy Endpoint to an AWS Endpoint</a></h3>
<p>A Smithy endpoint has an untyped, string-&gt;<code>Document</code> collection of properties. We need to interpret these properties to
handle actually resolving an endpoint. As part of the <code>AwsAuthStage</code>, we load authentication schemes from the endpoint
properties and use these to configure signing on the request.</p>
<p><strong>Note</strong>: Authentication schemes are <strong>NOT</strong> required as part of an endpoint. When the auth schemes are not set, the
default
authentication should be used. The Rust SDK will set <code>SigningRegion</code> and <code>SigningName</code> in the property bag by default
as part of <code>make_operation</code>.</p>
<h3 id="implementing-the-rules-engine"><a class="header" href="#implementing-the-rules-engine">Implementing the rules engine</a></h3>
<p>The Rust SDK code converts the rules into Rust code that will be compiled.</p>
<!-- Include a checklist of all the things that need to happen for this RFC's implementation to be considered complete -->
<h2 id="changes-checklist"><a class="header" href="#changes-checklist">Changes checklist</a></h2>
<p><strong>Rules Engine</strong></p>
<ul>
<li><input disabled="" type="checkbox" checked=""/>
Endpoint rules code generator</li>
<li><input disabled="" type="checkbox" checked=""/>
Endpoint params code generator</li>
<li><input disabled="" type="checkbox" checked=""/>
Endpoint tests code generator</li>
<li><input disabled="" type="checkbox" checked=""/>
Implement ruleset standard library functions as inlineables. Note: pending future refactoring work, the <code>aws.</code>
functions will need to be integrated into the smithy core endpoint resolver.</li>
<li><input disabled="" type="checkbox" checked=""/>
Implement partition function &amp; ability to customize partitions
<strong>SDK Integration</strong></li>
<li><input disabled="" type="checkbox" checked=""/>
Add a Smithy endpoint resolver to the service config, with a default that loads the default endpoint resolver.</li>
<li><input disabled="" type="checkbox" checked=""/>
Update <code>SdkConfig</code> to accept a URI instead of an implementation of <code>ResolveAwsEndpoint</code>. This change can be done
standalone.</li>
<li><input disabled="" type="checkbox" checked=""/>
Remove/deprecate the <code>ResolveAwsEndpoint</code> trait and replace it with the vanilla Smithy trait. Potentially, provide
a bridge.</li>
<li><input disabled="" type="checkbox" checked=""/>
Update <code>make_operation</code> to write a <a href="#the-endpoint-struct"><code>smithy::Endpoint</code></a> into the property bag</li>
<li><input disabled="" type="checkbox" checked=""/>
Update AWS Endpoint middleware to work off of a <a href="#the-endpoint-struct"><code>smithy::Endpoint</code></a></li>
<li><input disabled="" type="checkbox" checked=""/>
Wire the endpoint override to the <code>SDK::Endpoint</code> builtIn parameter</li>
<li><input disabled="" type="checkbox" checked=""/>
Remove the old smithy endpoint</li>
</ul>
<h2 id="alternative-designs"><a class="header" href="#alternative-designs">Alternative Designs</a></h2>
<h3 id="context-aware-endpoint-traits"><a class="header" href="#context-aware-endpoint-traits">Context Aware Endpoint Traits</a></h3>
<p>An alternative design that could provide more flexibility is a context-aware endpoint trait where the return type would
give context about the endpoint being returned. This would, for example, allow a customer to say explicitly &quot;don't
modify this endpoint&quot;:</p>
<pre><code class="language-rust ignore">enum ContextualEndpoint {
    /// Just the URI please. Pass it into the default endpoint resolver as a baseline
    Uri { uri: Uri, immutable: bool },

    /// A fully resolved, ready to rumble endpoint. Don't bother hitting the default endpoint resolver, just use what
    /// I've got.
    AwsEndpoint(AwsEndpoint)
}

trait ResolveGlobalEndpoint {
    fn resolve_endpoint(params: &amp;dyn Any) -&gt; Result&lt;ContextualEndpoint, EndpointResolutionError&gt;;
}</code></pre>
<p>Service clients would then use <code>ResolveGlobalEndpoint</code>, optional specified from <code>SdkConfig</code> to perform routing
decisions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../rfcs/rfc0026_client_crate_organization.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../rfcs/rfc0028_sdk_credential_cache_type_safety.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../rfcs/rfc0026_client_crate_organization.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../rfcs/rfc0028_sdk_credential_cache_type_safety.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../static/mermaid.min.js"></script>
        <script src="../static/mermaid-init.js"></script>


    </div>
    </body>
</html>
