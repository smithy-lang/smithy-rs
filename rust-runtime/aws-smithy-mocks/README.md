# aws-smithy-mocks

This package allows testing clients generated by smithy-rs (including all packages of the AWS Rust SDK) by using interceptors to return stub responses. This approach is quite useful for testing both happy-path and error scenarios and avoids the need for mocking the entire client or using traits.

## Basic Usage

```rust
#[tokio::test]
async fn test_s3() {
    // Create a rule that returns a successful response
    let s3_rule = mock!(Client::get_object).then_output(|| {
        GetObjectOutput::builder()
            .body(ByteStream::from_static(b"test-content"))
            .build()
    });
    
    // Create a mocked client with the rule
    let s3 = mock_client!(aws_sdk_s3, [&s3_rule]);
    
    // Use the client as you would normally
    let result = s3
        .get_object()
        .bucket("test-bucket")
        .key("test-key")
        .send()
        .await
        .expect("success response");
    
    // Verify the response
    let data = result.body.collect().await.expect("successful read").to_vec();
    assert_eq!(data, b"test-content");
    
    // Verify the rule was used
    assert_eq!(s3_rule.num_calls(), 1);
}
```

## Key Features

### Request Matching

You can match requests based on their properties:

```rust
let rule = mock!(Client::get_object)
    .match_requests(|req| req.bucket() == Some("test-bucket") && req.key() == Some("test-key"))
    .then_output(|| GetObjectOutput::builder().build());
```

### Different Response Types

Return different types of responses:

```rust
// Return a modeled output
let success_rule = mock!(Client::get_object)
    .then_output(|| GetObjectOutput::builder().build());

// Return a modeled error
let error_rule = mock!(Client::get_object)
    .then_error(|| GetObjectError::NoSuchKey(NoSuchKey::builder().build()));

// Return an HTTP response
let http_rule = mock!(Client::get_object)
    .then_http_response(|| HttpResponse::new(
        StatusCode::try_from(503).unwrap(),
        SdkBody::from("service unavailable")
    ));
```

### Testing Retry Behavior

Define sequences of responses for testing retry behavior:

```rust
let retry_rule = mock!(Client::get_object)
    .serve(|idx| match idx {
        0 | 1 => Some(mock_response!(status: 503)),  // First two calls return 503
        2 => Some(mock_response!(GetObjectOutput::builder().build())),  // Third call succeeds
        _ => None  // No more responses
    });
```

### Rule Modes

Control how rules are matched and applied:

```rust
// Sequential mode: Rules are tried in order, and when a rule is exhausted, the next rule is used
let client = mock_client!(aws_sdk_s3, RuleMode::Sequential, [&rule1, &rule2]);

// MatchAny mode: The first matching rule is used, regardless of order
let client = mock_client!(aws_sdk_s3, RuleMode::MatchAny, [&rule1, &rule2]);
```

<!-- anchor_start:footer -->
This crate is part of the [AWS SDK for Rust](https://awslabs.github.io/aws-sdk-rust/) and the [smithy-rs](https://github.com/smithy-lang/smithy-rs) code generator.
<!-- anchor_end:footer -->
